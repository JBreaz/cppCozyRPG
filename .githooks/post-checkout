#!/bin/sh
set -eu

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
. "$REPO_ROOT/Scripts/git-hooks/colors.sh"
. "$REPO_ROOT/Scripts/git-hooks/hook-common.sh"

HOOK_NAME="post-checkout"
hook_trace "start argv=$*"
hook_trace_state

OLDREV="$1"
NEWREV="$2"
IS_BRANCH_CHECKOUT="$3"

# LFS post-checkout
command -v git-lfs >/dev/null 2>&1 || {
  printf >&2 "\n%s\n\n" "This repository is configured for Git LFS but 'git-lfs' was not found on your path."
  exit 2
}
git lfs post-checkout "$@"

# Clean up stale markers when no rebase is active
if ! hook_is_rebase_in_progress; then
  hook_cleanup_stale_rebase_markers
fi

# Show conflict guidance if needed
hook_reset_ledgers_for_new_context_if_needed || true
if hook_should_show_guard_guidance; then
  hook_print_required_if_any || true
fi

# Exit early if not a branch checkout
[ "${IS_BRANCH_CHECKOUT:-0}" -ne 1 ] && exit 0

# Auto-pull main (existing behavior)
BRANCH="$(git symbolic-ref --short HEAD 2>/dev/null || true)"
FINAL_OLDREV="$OLDREV"
FINAL_NEWREV="$NEWREV"

if [ "$BRANCH" = "main" ]; then
  info "Checked out 'main' ? checking for upstream updates..."
  UE_SYNC_SUPPRESS=1 git fetch --all --prune --quiet || true

  UPSTREAM="@{upstream}"
  if git rev-parse --abbrev-ref "$UPSTREAM" >/dev/null 2>&1; then
    BEHIND="$(git rev-list --count HEAD.."$UPSTREAM" 2>/dev/null || true)"
    [ -z "${BEHIND:-}" ] && BEHIND=0

    if [ "$BEHIND" -gt 0 ]; then
      info "main is behind by $BEHIND commit(s). Preparing to pull..."

      PRE_PULL_HEAD="$(git rev-parse HEAD 2>/dev/null || true)"
      STASH_REF=""

      if ! git diff --quiet || ! git diff --cached --quiet; then
        warn "Working tree is dirty ? stashing local changes before pull..."
        UE_SYNC_SUPPRESS=1 git stash push -u -m "auto-post-checkout-main-$(date +%s)" >/dev/null 2>&1 || true
        STASH_REF="$(UE_SYNC_SUPPRESS=1 git stash list -1 --format=%gd 2>/dev/null || true)"
      fi

      if UE_SYNC_SUPPRESS=1 git pull --ff-only; then
        ok "Pulled latest changes into main."
      else
        error "Pull failed. There may be merge conflicts. (Contact Ronnie)"
      fi

      POST_PULL_HEAD="$(git rev-parse HEAD 2>/dev/null || true)"
      if [ -n "${PRE_PULL_HEAD:-}" ] && [ -n "${POST_PULL_HEAD:-}" ] && [ "$PRE_PULL_HEAD" != "$POST_PULL_HEAD" ]; then
        FINAL_OLDREV="$PRE_PULL_HEAD"
        FINAL_NEWREV="$POST_PULL_HEAD"
      fi

      if [ -n "${STASH_REF:-}" ]; then
        echo "Restoring stashed local changes ($STASH_REF)..."
        if UE_SYNC_SUPPRESS=1 git stash pop "$STASH_REF"; then
          ok "Local changes restored."
        else
          echo "WARNING: stash pop had conflicts or failed. Your stash is still available as: $STASH_REF"
          exit 1
        fi
      fi
    else
      echo "main is already up to date"
    fi
  else
    warn "No upstream configured for main"
  fi
fi

# UnrealSync once at end
hook_run_unrealsync "$FINAL_OLDREV" "$FINAL_NEWREV" "$IS_BRANCH_CHECKOUT"
exit $?
