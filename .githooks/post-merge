#!/bin/sh
set -eu

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || exit 0
. "$REPO_ROOT/Scripts/git-hooks/colors.sh"
. "$REPO_ROOT/Scripts/git-hooks/hook-common.sh"

HOOK_NAME="post-merge"
hook_trace "start argv=$*"
hook_trace_state

command -v git-lfs >/dev/null 2>&1 || {
  printf >&2 "\n%s\n\n" "This repository is configured for Git LFS but 'git-lfs' was not found on your path."
  exit 2
}

git lfs post-merge "$@" || true
git fetch --all --prune --quiet || true

# If merge produced conflicts, reset ledgers for this context + print guidance immediately
hook_reset_ledgers_for_new_context_if_needed || true
if hook_should_show_guard_guidance; then
  hook_print_required_if_any || true
fi


# UnrealSync after merge
OLDREV="$(git rev-parse ORIG_HEAD 2>/dev/null || true)"
NEWREV="$(git rev-parse HEAD 2>/dev/null || true)"
hook_run_unrealsync "$OLDREV" "$NEWREV" 1

exit 0
